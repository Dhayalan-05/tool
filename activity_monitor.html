<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Activity Dashboard</title>

<!-- Bootstrap + ChartJS + Axios -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<style>
body {
    background-color: #f8f9fa;
}
#dataTableContainer, #chartContainer {
    display: none;
    transition: all 0.5s ease-in-out;
}
.card {
    border-radius: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.flagged-row {
    background-color: #ffb3b3 !important;
}
.flag-indicator {
    color: #dc3545;
    margin-left: 5px;
    font-size: 14px;
}
.flag-badge {
    background-color: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    margin-left: 5px;
}
.status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 5px;
}
#loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}
.spinner-border {
    width: 4rem;
    height: 4rem;
}
.summary-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
}
.summary-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin: 0;
}
.summary-label {
    font-size: 0.9rem;
    opacity: 0.9;
}
</style>
</head>
<body class="p-4">

<!-- Loading Spinner -->
<div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container text-center">
    <h2 class="mb-3 text-primary">üìä Activity Monitoring Dashboard</h2>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="summary-card">
                <p class="summary-number" id="totalRecords">0</p>
                <p class="summary-label">Total Records</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <p class="summary-number" id="flaggedRecords">0</p>
                <p class="summary-label">Flagged Items</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <p class="summary-number" id="totalLabs">0</p>
                <p class="summary-label">Active Labs</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <p class="summary-number" id="totalSystems">0</p>
                <p class="summary-label">Active Systems</p>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row justify-content-center mb-3">
        <div class="col-md-3">
            <label class="form-label fw-bold">Select Date: 
                <span id="dateFlag" class="flag-indicator" style="display: none;">üö©</span>
            </label>
            <input type="date" id="datePicker" class="form-control" onchange="onDateChange()">
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Select Lab:
                <span id="labFlag" class="flag-indicator" style="display: none;">üö©</span>
            </label>
            <select id="labSelect" class="form-select" onchange="onLabChange()" disabled>
                <option value="">-- Select Lab --</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Select System:
                <span id="systemFlag" class="flag-indicator" style="display: none;">üö©</span>
            </label>
            <select id="systemSelect" class="form-select" onchange="onSystemChange()" disabled>
                <option value="">-- Select System --</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Select User:
                <span id="userFlag" class="flag-indicator" style="display: none;">üö©</span>
            </label>
            <select id="userSelect" class="form-select" onchange="onUserChange()" disabled>
                <option value="">-- Select User --</option>
            </select>
        </div>
    </div>

    <!-- Buttons -->
    <div class="mb-4">
        <button class="btn btn-success me-2" onclick="toggleTable()">Show Raw Data</button>
        <button class="btn btn-secondary me-2" onclick="reloadData()">üîÑ Refresh Live Data</button>
        <button class="btn btn-info" onclick="openPastDataModal()">üìÖ Past Data</button>
        <button class="btn btn-warning" onclick="clearFilters()">üóëÔ∏è Clear Filters</button>
    </div>

    <!-- Current Selection Summary -->
    <div class="alert alert-info mb-4" id="selectionSummary" style="display: none;">
        <strong>Current Selection:</strong> 
        <span id="selectedDateText"></span> | 
        <span id="selectedLabText"></span> | 
        <span id="selectedSystemText"></span> | 
        <span id="selectedUserText"></span>
        <span class="badge bg-danger ms-2" id="flaggedCountBadge" style="display: none;"></span>
    </div>

    <!-- Chart -->
    <div id="chartContainer" class="card p-3 mb-4">
        <h5 class="text-center">üìà Category Distribution</h5>
        <canvas id="activityChart" height="120"></canvas>
    </div>

    <!-- Raw Data Table -->
    <div id="dataTableContainer" class="card p-3">
        <h5 class="text-center">üìã Raw Activity Data</h5>
        <div class="table-responsive">
            <table class="table table-striped" id="dataTable">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Lab</th>
                        <th>System</th>
                        <th>User</th>
                        <th>Category</th>
                        <th>URL</th>
                        <th>Timestamp</th>
                        <th>Flag</th>
                    </tr>
                </thead>
                <tbody id="dataBody"></tbody>
            </table>
        </div>
        <button class="btn btn-danger mt-2" onclick="toggleTable()">Close Raw Data</button>
    </div>
</div>

<!-- Past Data Modal -->
<div class="modal fade" id="pastDataModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header">
        <h5 class="modal-title">üìÖ Fetch Past Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-start">
        <label class="fw-bold">Select Date:</label>
        <input type="date" id="pastDate" class="form-control mb-3" onchange="onPastDateChange()">

        <label class="fw-bold">Select Lab:</label>
        <select id="pastLab" class="form-select mb-3" onchange="onPastLabChange()" disabled>
          <option value="">-- Choose Lab --</option>
        </select>

        <label class="fw-bold">Select System:</label>
        <select id="pastSystem" class="form-select mb-3" disabled>
          <option value="">-- Choose System --</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="fetchPastData()">Fetch Data</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
let chart;
let allData = [];
let labs = {};
let selectedDate = "";
let selectedLab = "";
let selectedSystem = "";
let selectedUser = "";

function showLoading() { document.getElementById("loadingOverlay").style.display = "flex"; }
function hideLoading() { document.getElementById("loadingOverlay").style.display = "none"; }

document.addEventListener("DOMContentLoaded", () => {
    loadLiveData();
    setInterval(loadLiveData, 5000);
    // Set today's date by default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("datePicker").value = today;
    selectedDate = today;
    loadLabs(today);
});

async function loadLiveData() {
    try {
        const res = await axios.get("/data", {
            auth: { username: "admin", password: "myStrongPassword123" }
        });
        allData = res.data || [];
        updateSummaryCards();
        updateSelectionSummary();
    } catch (err) {
        console.error("Error fetching data:", err);
    }
}

function updateSummaryCards() {
    document.getElementById("totalRecords").textContent = allData.length;
    
    const flaggedCount = allData.filter(r => r.flagged === 1).length;
    document.getElementById("flaggedRecords").textContent = flaggedCount;
    
    const uniqueLabs = new Set(allData.map(r => r.lab_name));
    document.getElementById("totalLabs").textContent = uniqueLabs.size;
    
    const uniqueSystems = new Set(allData.map(r => r.system_name));
    document.getElementById("totalSystems").textContent = uniqueSystems.size;
}

function updateSelectionSummary() {
    const summary = document.getElementById("selectionSummary");
    const currentData = getFilteredData();
    
    if (currentData.length > 0) {
        document.getElementById("selectedDateText").textContent = selectedDate || "All Dates";
        document.getElementById("selectedLabText").textContent = selectedLab || "All Labs";
        document.getElementById("selectedSystemText").textContent = selectedSystem || "All Systems";
        document.getElementById("selectedUserText").textContent = selectedUser || "All Users";
        
        const flaggedCount = currentData.filter(r => r.flagged === 1).length;
        const flaggedBadge = document.getElementById("flaggedCountBadge");
        if (flaggedCount > 0) {
            flaggedBadge.textContent = `${flaggedCount} Flagged`;
            flaggedBadge.style.display = "inline";
        } else {
            flaggedBadge.style.display = "none";
        }
        
        summary.style.display = "block";
    } else {
        summary.style.display = "none";
    }
}

function onDateChange() {
    selectedDate = document.getElementById("datePicker").value;
    updateFlagIndicators();
    if (!selectedDate) return;
    loadLabs(selectedDate);
}

async function loadLabs(date) {
    showLoading();
    try {
        const res = await axios.get(`/labs?date=${date}`, {
            auth: { username: "admin", password: "myStrongPassword123" }
        });
        labs = res.data || {};
        const labSelect = document.getElementById("labSelect");
        labSelect.innerHTML = `<option value="">-- Select Lab --</option>`;
        
        if (Object.keys(labs).length === 0) {
            alert("No labs have data on this date.");
            labSelect.disabled = true;
            hideLoading();
            return;
        }
        
        Object.keys(labs).forEach(lab => {
            const opt = document.createElement("option");
            opt.value = lab;
            const hasFlagged = labs[lab].some(sys => sys.flagged === 1);
            opt.textContent = lab + (hasFlagged ? " üö©" : "");
            opt.dataset.flagged = hasFlagged;
            labSelect.appendChild(opt);
        });
        
        labSelect.disabled = false;
        document.getElementById("systemSelect").disabled = true;
        document.getElementById("userSelect").disabled = true;
        updateFlagIndicators();
    } catch (err) {
        console.error("Error loading labs:", err);
    } finally {
        hideLoading();
    }
}

function onLabChange() {
    selectedLab = document.getElementById("labSelect").value;
    const systemSelect = document.getElementById("systemSelect");
    systemSelect.innerHTML = `<option value="">-- Select System --</option>`;
    
    if (!selectedLab || !labs[selectedLab]) {
        systemSelect.disabled = true;
        document.getElementById("userSelect").disabled = true;
        updateFlagIndicators();
        return;
    }
    
    labs[selectedLab].forEach(sys => {
        const opt = document.createElement("option");
        opt.value = sys.system_name;
        opt.textContent = sys.system_name + (sys.flagged === 1 ? " üö©" : "");
        opt.dataset.flagged = sys.flagged === 1;
        systemSelect.appendChild(opt);
    });
    
    systemSelect.disabled = false;
    document.getElementById("userSelect").disabled = true;
    updateFlagIndicators();
}

function onSystemChange() {
    selectedSystem = document.getElementById("systemSelect").value;
    if (!selectedSystem) return;

    // Populate user dropdown dynamically
    const users = [...new Set(allData
        .filter(r => r.lab_name === selectedLab && r.system_name === selectedSystem)
        .map(r => r.user_name || 'Unknown')
    )];
    
    const userSelect = document.getElementById("userSelect");
    userSelect.innerHTML = `<option value="">-- Select User --</option>`;
    
    users.forEach(u => {
        const opt = document.createElement("option");
        opt.value = u;
        // Check if user has any flagged items
        const userFlagged = allData.some(r => 
            r.lab_name === selectedLab && 
            r.system_name === selectedSystem && 
            r.user_name === u && 
            r.flagged === 1
        );
        opt.textContent = u + (userFlagged ? " üö©" : "");
        opt.dataset.flagged = userFlagged;
        userSelect.appendChild(opt);
    });
    
    userSelect.disabled = users.length === 0;
    updateFlagIndicators();
    filterAndRender();
}

function onUserChange() {
    selectedUser = document.getElementById("userSelect").value;
    updateFlagIndicators();
    filterAndRender();
}

function updateFlagIndicators() {
    // Update flag indicators based on current selection
    const dateFlag = document.getElementById("dateFlag");
    const labFlag = document.getElementById("labFlag");
    const systemFlag = document.getElementById("systemFlag");
    const userFlag = document.getElementById("userFlag");
    
    // Date flag - show if any data for this date has flags
    const dateHasFlags = selectedDate && allData.some(r => 
        r.timestamp.startsWith(selectedDate) && r.flagged === 1
    );
    dateFlag.style.display = dateHasFlags ? "inline" : "none";
    
    // Lab flag
    const labHasFlags = selectedLab && labs[selectedLab] && 
        labs[selectedLab].some(sys => sys.flagged === 1);
    labFlag.style.display = labHasFlags ? "inline" : "none";
    
    // System flag
    const systemOption = document.querySelector(`#systemSelect option[value="${selectedSystem}"]`);
    const systemHasFlags = systemOption && systemOption.dataset.flagged === "true";
    systemFlag.style.display = systemHasFlags ? "inline" : "none";
    
    // User flag
    const userOption = document.querySelector(`#userSelect option[value="${selectedUser}"]`);
    const userHasFlags = userOption && userOption.dataset.flagged === "true";
    userFlag.style.display = userHasFlags ? "inline" : "none";
}

function getFilteredData() {
    let dataToShow = allData;
    if (selectedDate) dataToShow = dataToShow.filter(r => r.timestamp.startsWith(selectedDate));
    if (selectedLab) dataToShow = dataToShow.filter(r => r.lab_name === selectedLab);
    if (selectedSystem) dataToShow = dataToShow.filter(r => r.system_name === selectedSystem);
    if (selectedUser) dataToShow = dataToShow.filter(r => r.user_name === selectedUser);
    return dataToShow;
}

function filterAndRender() {
    const dataToShow = getFilteredData();
    
    if (dataToShow.length > 0) {
        document.getElementById("chartContainer").style.display = "block";
        document.getElementById("dataTableContainer").style.display = "block";
    } else {
        document.getElementById("chartContainer").style.display = "none";
        document.getElementById("dataTableContainer").style.display = "none";
    }

    renderChart(dataToShow);
    renderTable(dataToShow);
    updateSelectionSummary();
    updateFlagIndicators();
}

function clearFilters() {
    selectedDate = "";
    selectedLab = "";
    selectedSystem = "";
    selectedUser = "";
    
    document.getElementById("datePicker").value = "";
    document.getElementById("labSelect").value = "";
    document.getElementById("systemSelect").value = "";
    document.getElementById("userSelect").value = "";
    
    document.getElementById("labSelect").disabled = true;
    document.getElementById("systemSelect").disabled = true;
    document.getElementById("userSelect").disabled = true;
    
    updateFlagIndicators();
    filterAndRender();
}

function toggleTable() {
    const tableDiv = document.getElementById("dataTableContainer");
    const chartDiv = document.getElementById("chartContainer");
    tableDiv.style.display = tableDiv.style.display === "none" ? "block" : "none";
}

function reloadData() { 
    loadLiveData(); 
    // Re-apply current filters after reload
    setTimeout(() => {
        if (selectedDate || selectedLab || selectedSystem || selectedUser) {
            filterAndRender();
        }
    }, 1000);
}

function openPastDataModal() {
    const modal = new bootstrap.Modal(document.getElementById("pastDataModal"));
    modal.show();
}

function renderChart(data) {
    const ctx = document.getElementById('activityChart').getContext('2d');
    const categoryCount = {};
    data.forEach(r => {
        if (r.category) categoryCount[r.category] = (categoryCount[r.category] || 0) + 1;
    });
    const labels = Object.keys(categoryCount);
    const values = Object.values(categoryCount);
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels.length ? labels : ["No Data"],
            datasets: [{
                data: values.length ? values : [1],
                backgroundColor: ['#36a2eb','#ff6384','#ff9f40','#4bc0c0','#9966ff','#ffcd56','#c9cbcf','#4dc9f6','#f67019','#537bc4'],
                borderWidth: 1
            }]
        },
        options: { 
            responsive: true, 
            animation: { animateScale: true },
            plugins: {
                legend: {
                    position: 'right',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderTable(data) {
    const body = document.getElementById("dataBody");
    body.innerHTML = "";
    data.forEach(r => {
        const tr = document.createElement("tr");
        if (r.flagged === 1) tr.classList.add("flagged-row");
        tr.innerHTML = `
            <td>${r.id}</td>
            <td>${r.lab_name}</td>
            <td>${r.system_name}</td>
            <td>${r.user_name || '-'}</td>
            <td>${r.category}</td>
            <td><a href="${r.url}" target="_blank">${r.url.substring(0, 50)}${r.url.length > 50 ? '...' : ''}</a></td>
            <td>${new Date(r.timestamp).toLocaleString()}</td>
            <td>
                <button class="btn btn-sm ${r.flagged ? 'btn-warning' : 'btn-outline-danger'}"
                    onclick="toggleFlag('${r.id}', ${r.flagged})">
                    ${r.flagged ? 'üö© Unflag' : 'Flag'}
                </button>
            </td>
        `;
        body.appendChild(tr);
    });
}

async function toggleFlag(id, flagged) {
    showLoading();
    const endpoint = flagged ? "/unflag" : "/flag";
    try {
        await axios.post(endpoint, { id }, {
            auth: { username: "admin", password: "myStrongPassword123" }
        });
        // Reload data to reflect changes
        await loadLiveData();
        // Re-apply current filters
        filterAndRender();
    } catch (err) {
        console.error("Error toggling flag:", err);
        alert("Error updating flag status");
    } finally {
        hideLoading();
    }
}

// Past data modal functions (unchanged)
async function onPastDateChange() {
    const date = document.getElementById("pastDate").value;
    if (!date) return;
    showLoading();
    try {
        const res = await axios.get(`/labs?date=${date}`, {
            auth: { username: "admin", password: "myStrongPassword123" }
        });
        const labsData = res.data || {};
        const pastLab = document.getElementById("pastLab");
        pastLab.innerHTML = `<option value="">-- Choose Lab --</option>`;
        Object.keys(labsData).forEach(lab => {
            const opt = document.createElement("option");
            opt.value = lab;
            opt.textContent = lab;
            pastLab.appendChild(opt);
        });
        pastLab.disabled = Object.keys(labsData).length === 0;
        if (Object.keys(labsData).length === 0) {
            alert("No labs found for this date.");
        }
        document.getElementById("pastSystem").innerHTML = `<option value="">-- Choose System --</option>`;
        document.getElementById("pastSystem").disabled = true;
    } catch (err) {
        console.error("Error loading past labs:", err);
    } finally {
        hideLoading();
    }
}

async function onPastLabChange() {
    const lab = document.getElementById("pastLab").value;
    const date = document.getElementById("pastDate").value;
    if (!lab || !date) return;
    const res = await axios.get(`/labs?date=${date}`, {
        auth: { username: "admin", password: "myStrongPassword123" }
    });
    const systems = res.data[lab] || [];
    const pastSystem = document.getElementById("pastSystem");
    pastSystem.innerHTML = `<option value="">-- Choose System --</option>`;
    systems.forEach(sys => {
        const opt = document.createElement("option");
        opt.value = sys.system_name;
        opt.textContent = sys.system_name;
        pastSystem.appendChild(opt);
    });
    pastSystem.disabled = systems.length === 0;
    if (systems.length === 0) alert("No systems available for this lab/date.");
}

async function fetchPastData() {
    const date = document.getElementById("pastDate").value;
    const lab = document.getElementById("pastLab").value;
    const system = document.getElementById("pastSystem").value;
    if (!date || !lab || !system) {
        alert("Please select date, lab, and system.");
        return;
    }
    showLoading();
    try {
        const res = await axios.get(`/data?date=${date}`, {
            auth: { username: "admin", password: "myStrongPassword123" }
        });
        allData = res.data.filter(r => r.lab_name === lab && r.system_name === system);
        if (allData.length === 0) {
            alert("No data found for the selected date/lab/system.");
            document.getElementById("chartContainer").style.display = "none";
            document.getElementById("dataTableContainer").style.display = "none";
        } else {
            // Set the filters
            selectedDate = date;
            selectedLab = lab;
            selectedSystem = system;
            document.getElementById("datePicker").value = date;
            document.getElementById("labSelect").value = lab;
            document.getElementById("systemSelect").value = system;
            updateFlagIndicators();
            filterAndRender();
        }
        bootstrap.Modal.getInstance(document.getElementById("pastDataModal")).hide();
    } catch (err) {
        console.error("Error fetching past data:", err);
    } finally {
        hideLoading();
    }
}
</script>
</body>
</html>
