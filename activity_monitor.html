<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ActivityMonitor Pro — Labs Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: "Segoe UI", Tahoma, sans-serif; background:#f4f6f8; margin:0; padding:20px; color:#222; }
    .wrap { max-width:1100px; margin:0 auto; }
    h1 { text-align:center; margin-bottom:6px; }
    p.lead { text-align:center; color:#666; margin-top:0; }
    .top { display:flex; justify-content:space-between; gap:12px; align-items:flex-start; margin:18px 0; }
    .left, .right { background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
    .left { flex:0 0 320px; }
    .right { flex:1; min-height:380px; }
    .lab-item { padding:8px; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
    .lab-item:hover { background:#f0f8ff; }
    .flag { width:12px; height:12px; border-radius:50%; display:inline-block; margin-left:6px; }
    .system-list { margin-left:10px; margin-top:6px; }
    .system-item { padding:6px 8px; margin:4px 0; border-radius:6px; background:#fafafa; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
    .system-item:hover { background:#f0f8ff; }
    .controls { margin-bottom:12px; display:flex; gap:8px; align-items:center; }
    canvas { background:#fff; border-radius:8px; padding:10px; }
    .summary { margin-top:12px; color:#444; }
    .note { color:#777; font-size:13px; margin-top:8px; }
    button { padding:4px 8px; cursor:pointer; border:1px solid #aaa; background:#f5f5f5; border-radius:4px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ActivityMonitor Pro — Labs Dashboard</h1>
    <p class="lead">Click a lab to expand systems. Click a system to view activity category composition. Flags show restricted activity.</p>

    <div class="top">
      <div class="left" id="leftPanel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>Labs & Systems</strong>
          <button onclick="refreshAll()">Refresh</button>
        </div>
        <div id="labsContainer" style="margin-top:10px;"></div>
        <div class="note">Auto-refreshes every 20s.</div>
      </div>

      <div class="right">
        <div class="controls">
          <button onclick="toggleLivePast()"><span id="modeBtn">Live</span> Mode</button>
          <div><strong id="selectedTitle">Select a system</strong></div>
        </div>
        <canvas id="pieChart" width="540" height="300"></canvas>
        <div class="summary" id="summaryText"></div>
        <div class="summary" id="rawDataText" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_BASE = "http://127.0.0.1:8000"; // admin IP
    const ENDPOINT_LABS = API_BASE + "/labs";
    const ENDPOINT_LAB_SUM = API_BASE + "/lab_summary";
    const ENDPOINT_SYS_SUM = API_BASE + "/system_summary";
    const ENDPOINT_DATA = API_BASE + "/data";

    let pieChart = null;
    let currentSelection = { type:null, name:null, lab:null };
    let liveMode = true;

    async function fetchJSON(url) {
      const res = await fetch(url);
      if(!res.ok) throw new Error("HTTP "+res.status);
      return res.json();
    }

    async function refreshAll() {
      try {
        const labs = await fetchJSON(ENDPOINT_LABS);
        renderLabs(labs);
      } catch(err) {
        document.getElementById("labsContainer").innerHTML = "<div style='color:red'>Failed to fetch labs.</div>";
        console.error(err);
      }
    }

    function renderLabs(labs) {
      const container = document.getElementById("labsContainer");
      container.innerHTML = "";
      if(!labs || Object.keys(labs).length===0){
        container.innerHTML = "<div>No labs connected.</div>";
        return;
      }
      const restrictedSites = ["chatgpt","gemini","perplexity"];
      const allowedIPs = ["110.171.151.102"];

      for(const [lab, systems] of Object.entries(labs)){
        let labFlag = false;
        const labDiv = document.createElement("div");
        labDiv.className = "lab-item";
        labDiv.innerHTML = `<div><strong>${lab}</strong></div><div id="flag_${lab}"></div>`;
        
        // System list
        const sysList = document.createElement("div");
        sysList.className = "system-list";
        sysList.style.display="none";
        systems.forEach(sys=>{
          const s = document.createElement("div");
          s.className="system-item";
          s.textContent=sys;

          s.onclick=()=>selectSystem(sys, lab);
          sysList.appendChild(s);
        });

        // Flag check (fetch past data for this lab)
        fetchJSON(ENDPOINT_LAB_SUM+"?lab="+encodeURIComponent(lab))
        .then(data=>{
          let flagSystems=[];
          Object.entries(data).forEach(([cat,count])=>{
            restrictedSites.forEach(site=>{
              if(cat.toLowerCase().includes(site)) flagSystems.push(site);
            });
          });
          // If any restricted activity
          if(flagSystems.length>0){
            labFlag=true;
            const flagElem=document.createElement("span");
            flagElem.className="flag";
            flagElem.style.background="red";
            labDiv.querySelector("#flag_"+lab).appendChild(flagElem);
          }
        }).catch(e=>console.log(e));

        labDiv.onclick=()=>{ sysList.style.display=(sysList.style.display==="block")?"none":"block"; };
        container.appendChild(labDiv);
        container.appendChild(sysList);
      }
    }

    async function selectSystem(systemName, labName){
      currentSelection={type:"system", name:systemName, lab:labName};
      document.getElementById("selectedTitle").textContent=`System: ${systemName} (Lab: ${labName})`;
      await updatePieForSystem(systemName);
      await showRawData(systemName);
    }

    async function updatePieForSystem(systemName){
      try{
        let endpoint = ENDPOINT_SYS_SUM+"?system="+encodeURIComponent(systemName);
        const data = await fetchJSON(endpoint);
        renderPieChart(data);
        const total=Object.values(data).reduce((a,b)=>a+b,0);
        document.getElementById("summaryText").textContent=`Total activities: ${total}`;
      } catch(err){
        console.error(err);
        document.getElementById("summaryText").textContent="Failed to load summary.";
      }
    }

    async function showRawData(systemName){
      try{
        const allData=await fetchJSON(ENDPOINT_DATA);
        const filtered=allData.filter(r=>r.system_name===systemName);
        let html="<strong>Recent Activities:</strong><br>";
        filtered.slice(-20).forEach(r=>{
          html+=`${r.timestamp} | ${r.browser} | ${r.title} | ${r.url} | ${r.category}<br>`;
        });
        document.getElementById("rawDataText").innerHTML=html;
      } catch(err){
        document.getElementById("rawDataText").textContent="Failed to load raw data.";
      }
    }

    function renderPieChart(dataObj){
      const labels=Object.keys(dataObj);
      const values=Object.values(dataObj);
      const colors=["#4CAF50","#FF9800","#2196F3","#9C27B0","#F44336","#00BCD4","#FFC107","#8BC34A"];
      const ctx=document.getElementById("pieChart").getContext("2d");
      if(pieChart) pieChart.destroy();
      pieChart=new Chart(ctx,{
        type:'pie',
        data:{labels:labels,datasets:[{data:values,backgroundColor:colors.slice(0,labels.length)}]},
        options:{responsive:true,plugins:{legend:{position:'bottom'}}}
      });
    }

    function toggleLivePast(){
      liveMode=!liveMode;
      document.getElementById("modeBtn").textContent=liveMode?"Live":"Past";
      if(currentSelection.type==="system"){
        updatePieForSystem(currentSelection.name);
        showRawData(currentSelection.name);
      }
    }

    setInterval(refreshAll,20000);
    window.onload=refreshAll;
  </script>
</body>
</html>
