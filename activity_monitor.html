<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Activity Dashboard</title>

<!-- Bootstrap + ChartJS + Axios -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<style>
body {
    background-color: #f8f9fa;
}
#dataTableContainer, #chartContainer {
    display: none;
    transition: all 0.5s ease-in-out;
}
.card {
    border-radius: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.flagged-row {
    background-color: #ffb3b3 !important;
}

/* Loading Spinner */
#loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}
.spinner-border {
    width: 4rem;
    height: 4rem;
}
</style>
</head>
<body class="p-4">

<!-- Loading Spinner -->
<div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container text-center">
    <h2 class="mb-3 text-primary">ðŸ“Š Activity Monitoring Dashboard</h2>

    <!-- Filters -->
    <div class="row justify-content-center mb-3">
        <div class="col-md-3">
            <label class="form-label fw-bold">Select Date:</label>
            <input type="date" id="datePicker" class="form-control" onchange="onDateChange()">
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Select Lab:</label>
            <select id="labSelect" class="form-select" onchange="onLabChange()" disabled>
                <option value="">-- Select Lab --</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Select System:</label>
            <select id="systemSelect" class="form-select" onchange="onSystemChange()" disabled>
                <option value="">-- Select System --</option>
            </select>
        </div>
    </div>

    <!-- Buttons -->
    <div class="mb-4">
        <button class="btn btn-success me-2" onclick="toggleTable()">Show Raw Data</button>
        <button class="btn btn-secondary me-2" onclick="reloadData()">ðŸ”„ Refresh Live Data</button>
        <button class="btn btn-info" onclick="openPastDataModal()">ðŸ“… Past Data</button>
    </div>

    <!-- Chart -->
    <div id="chartContainer" class="card p-3 mb-4">
        <h5 class="text-center">ðŸ“ˆ Category Distribution</h5>
        <canvas id="activityChart" height="120"></canvas>
    </div>

    <!-- Raw Data Table -->
    <div id="dataTableContainer" class="card p-3">
        <h5 class="text-center">ðŸ“‹ Raw Activity Data</h5>
        <div class="table-responsive">
            <table class="table table-striped" id="dataTable">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Lab</th>
                        <th>System</th>
                        <th>Category</th>
                        <th>URL</th>
                        <th>Timestamp</th>
                        <th>Flag</th>
                    </tr>
                </thead>
                <tbody id="dataBody"></tbody>
            </table>
        </div>
        <button class="btn btn-danger mt-2" onclick="toggleTable()">Close Raw Data</button>
    </div>
</div>

<!-- Past Data Modal -->
<div class="modal fade" id="pastDataModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header">
        <h5 class="modal-title">ðŸ“… Fetch Past Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-start">
        <label class="fw-bold">Select Date:</label>
        <input type="date" id="pastDate" class="form-control mb-3" onchange="onPastDateChange()">

        <label class="fw-bold">Select Lab:</label>
        <select id="pastLab" class="form-select mb-3" onchange="onPastLabChange()" disabled>
          <option value="">-- Choose Lab --</option>
        </select>

        <label class="fw-bold">Select System:</label>
        <select id="pastSystem" class="form-select mb-3" disabled>
          <option value="">-- Choose System --</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="fetchPastData()">Fetch Data</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
let chart;
let allData = [];
let labs = {};
let selectedDate = "";
let selectedLab = "";
let selectedSystem = "";

function showLoading() {
    document.getElementById("loadingOverlay").style.display = "flex";
}
function hideLoading() {
    document.getElementById("loadingOverlay").style.display = "none";
}

document.addEventListener("DOMContentLoaded", () => {
    loadLiveData();
    setInterval(loadLiveData, 5000);
});

async function loadLiveData() {
    try {
        const res = await axios.get("/data", {
            auth: { username: "admin", password: "myStrongPassword123" }
        });
        allData = res.data || [];
    } catch (err) {
        console.error("Error fetching data:", err);
    }
}

function onDateChange() {
    selectedDate = document.getElementById("datePicker").value;
    if (!selectedDate) return;
    loadLabs(selectedDate);
}

async function loadLabs(date) {
    showLoading();
    try {
        const res = await axios.get(`/labs?date=${date}`, {
            auth: { username: "admin", password: "myStrongPassword123" }
        });
        labs = res.data || {};
        const labSelect = document.getElementById("labSelect");
        labSelect.innerHTML = `<option value="">-- Select Lab --</option>`;
        if (Object.keys(labs).length === 0) {
            alert("No labs have data on this date.");
            labSelect.disabled = true;
            hideLoading();
            return;
        }
        Object.keys(labs).forEach(lab => {
            const opt = document.createElement("option");
            opt.value = lab;
            opt.textContent = lab;
            labSelect.appendChild(opt);
        });
        labSelect.disabled = false;
        document.getElementById("systemSelect").disabled = true;
    } catch (err) {
        console.error("Error loading labs:", err);
    } finally {
        hideLoading();
    }
}

function onLabChange() {
    selectedLab = document.getElementById("labSelect").value;
    const systemSelect = document.getElementById("systemSelect");
    systemSelect.innerHTML = `<option value="">-- Select System --</option>`;
    if (!selectedLab || !labs[selectedLab]) {
        systemSelect.disabled = true;
        return;
    }
    labs[selectedLab].forEach(sys => {
        const opt = document.createElement("option");
        opt.value = sys.system_name;
        opt.textContent = sys.system_name;
        systemSelect.appendChild(opt);
    });
    systemSelect.disabled = false;
}

function onSystemChange() {
    selectedSystem = document.getElementById("systemSelect").value;
    if (!selectedSystem) return;
    filterAndRender();
}

function toggleTable() {
    const tableDiv = document.getElementById("dataTableContainer");
    const chartDiv = document.getElementById("chartContainer");
    if (tableDiv.style.display === "none") {
        tableDiv.style.display = "block";
        chartDiv.style.transform = "translateY(-20px)";
    } else {
        tableDiv.style.display = "none";
        chartDiv.style.transform = "translateY(0)";
    }
}

function reloadData() {
    loadLiveData();
}

function openPastDataModal() {
    const modal = new bootstrap.Modal(document.getElementById("pastDataModal"));
    modal.show();
}

async function onPastDateChange() {
    const date = document.getElementById("pastDate").value;
    if (!date) return;
    showLoading();
    try {
        const res = await axios.get(`/labs?date=${date}`, {
            auth: { username: "admin", password: "myStrongPassword123" }
        });
        const labsData = res.data || {};
        const pastLab = document.getElementById("pastLab");
        pastLab.innerHTML = `<option value="">-- Choose Lab --</option>`;
        Object.keys(labsData).forEach(lab => {
            const opt = document.createElement("option");
            opt.value = lab;
            opt.textContent = lab;
            pastLab.appendChild(opt);
        });
        pastLab.disabled = Object.keys(labsData).length === 0;
        if (Object.keys(labsData).length === 0) {
            alert("No labs found for this date.");
        }
        document.getElementById("pastSystem").innerHTML = `<option value="">-- Choose System --</option>`;
        document.getElementById("pastSystem").disabled = true;
    } catch (err) {
        console.error("Error loading past labs:", err);
    } finally {
        hideLoading();
    }
}

async function onPastLabChange() {
    const lab = document.getElementById("pastLab").value;
    const date = document.getElementById("pastDate").value;
    if (!lab || !date) return;
    const res = await axios.get(`/labs?date=${date}`, {
        auth: { username: "admin", password: "myStrongPassword123" }
    });
    const systems = res.data[lab] || [];
    const pastSystem = document.getElementById("pastSystem");
    pastSystem.innerHTML = `<option value="">-- Choose System --</option>`;
    systems.forEach(sys => {
        const opt = document.createElement("option");
        opt.value = sys.system_name;
        opt.textContent = sys.system_name;
        pastSystem.appendChild(opt);
    });
    pastSystem.disabled = systems.length === 0;
    if (systems.length === 0) alert("No systems available for this lab/date.");
}

async function fetchPastData() {
    const date = document.getElementById("pastDate").value;
    const lab = document.getElementById("pastLab").value;
    const system = document.getElementById("pastSystem").value;
    if (!date || !lab || !system) {
        alert("Please select date, lab, and system.");
        return;
    }
    showLoading();
    try {
        const res = await axios.get(`/data?date=${date}`, {
            auth: { username: "admin", password: "myStrongPassword123" }
        });
        allData = res.data.filter(r => r.lab_name === lab && r.system_name === system);
        if (allData.length === 0) {
            alert("No data found for the selected date/lab/system.");
            document.getElementById("chartContainer").style.display = "none";
            document.getElementById("dataTableContainer").style.display = "none";
        } else {
            renderChart(allData);
            renderTable(allData);
            document.getElementById("chartContainer").style.display = "block";
            document.getElementById("dataTableContainer").style.display = "block";
        }
        bootstrap.Modal.getInstance(document.getElementById("pastDataModal")).hide();
    } catch (err) {
        console.error("Error fetching past data:", err);
    } finally {
        hideLoading();
    }
}

function filterAndRender() {
    let dataToShow = allData;
    if (selectedDate) dataToShow = dataToShow.filter(r => r.timestamp.startsWith(selectedDate));
    if (selectedLab) dataToShow = dataToShow.filter(r => r.lab_name === selectedLab);
    if (selectedSystem) dataToShow = dataToShow.filter(r => r.system_name === selectedSystem);

    if (dataToShow.length > 0) {
        document.getElementById("chartContainer").style.display = "block";
        document.getElementById("dataTableContainer").style.display = "block";
    } else {
        document.getElementById("chartContainer").style.display = "none";
        document.getElementById("dataTableContainer").style.display = "none";
        alert("No data available for this date/lab/system.");
    }

    renderChart(dataToShow);
    renderTable(dataToShow);
}

function renderChart(data) {
    const ctx = document.getElementById('activityChart').getContext('2d');
    const categoryCount = {};
    data.forEach(r => {
        if (r.category) categoryCount[r.category] = (categoryCount[r.category] || 0) + 1;
    });
    const labels = Object.keys(categoryCount);
    const values = Object.values(categoryCount);

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels.length ? labels : ["No Data"],
            datasets: [{
                data: values.length ? values : [1],
                backgroundColor: ['#36a2eb','#ff6384','#ff9f40','#4bc0c0','#9966ff'],
                borderWidth: 1
            }]
        },
        options: { responsive: true, animation: { animateScale: true } }
    });
}

function renderTable(data) {
    const body = document.getElementById("dataBody");
    body.innerHTML = "";
    data.forEach(r => {
        const tr = document.createElement("tr");
        if (r.flagged === 1) tr.classList.add("flagged-row");
        tr.innerHTML = `
            <td>${r.id}</td>
            <td>${r.lab_name}</td>
            <td>${r.system_name}</td>
            <td>${r.category}</td>
            <td><a href="${r.url}" target="_blank">${r.url}</a></td>
            <td>${r.timestamp}</td>
            <td>
                <button class="btn btn-sm ${r.flagged ? 'btn-warning' : 'btn-outline-danger'}"
                    onclick="toggleFlag(${r.id}, ${r.flagged})">
                    ${r.flagged ? 'Unflag' : 'Flag'}
                </button>
            </td>
        `;
        body.appendChild(tr);
    });
}

async function toggleFlag(id, flagged) {
    showLoading();
    const endpoint = flagged ? "/unflag" : "/flag";
    await axios.post(endpoint, { id }, {
        auth: { username: "admin", password: "myStrongPassword123" }
    });
    hideLoading();
    reloadData();
}
</script>
</body>
</html>
